---
title: "Manipulating Stics XML files"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Manipulate_Stics_XML_files}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---


```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  tidy=TRUE
)
```


```{r}
library(SticsRFiles)
```

```{r setup, results='hide', echo=FALSE}
options(warn=-1)
xml_loc_dir <- normalizePath(tempdir(), winslash = "/", mustWork = FALSE)
```




```{r rm_files, results='hide', echo=F}
files_list <- list.files(path = xml_loc_dir, pattern = "\\.xml$", full.names = T)
files_list
if (length(files_list))  {
  print("Removing files")
  file.remove(files_list)
}
```


# Introduction
The purpose of this document is to provide starting information about:

* how parameters are defined in Stics XML files
* how to use SticsRFiles functions for extracting data from XML Stics input files
* how to use SticsRFiles functions for replacing data into them.

Simple functions reproducible use cases based on 2 essential functions **get_param_xml** and **set_param_xml** are described in this document.

Exploring files content for files sets are also possible.

But, some queries kind are not taken into account. Some conditional queries are possible to do using parent nodes/attribues like getting soil parameters for a usm selection. But, queries inspecting elements downwards are not available for the moment. For example, getting soil names/parameters using a criterion like argi values > 20 ...  




# Understanding what are parameters in Stics XML files

XML files are self documented files and hierarchically structured. Syntaxic rules are based on what we call nodes (i.e. nodes names, similar to html tags) and attributes (nodes attributes values).


Stics XML files are filled with different kinds of parameters description
structures according to their type/role in the model formalisms.

As we can see in the above XML file extract from a general parameter file:    

* Parameters are grouped according to formalisms (in a `xml <formalisme>...</formalisme> ` block)

* Parameters may be defined by single values
This kind of definition is common for all files types and the parameter name is stored in the `nom` attribute of a `param` XML node. So the first parameter name in the example is `beta` and its value is `1.40000` (inside `param` tags).

* Option parameters (with or without attached parameters, eventually with sub-option)
The corresponding parameter name for an **option** node is stored in an attribute named `nomParam` and the corresponding value is given in the attribute `choix` of the option node. For example, the value of the parameter `codesymbiose` is `2` in the example.


```xml
<formalisme nom="Water absorption and nitrogen content of the plant">
<param format="real" max="2.0" min="1.0" nom="beta">1.40000</param>
<param format="real" max="1.0" min="0.2" nom="lvopt">0.50000</param>
<param format="real" max="0.07" min="0.0050" nom="rayon">0.02000</param>
<param format="real" max="0.1" min="0.01" nom="difN">0.04500</param>
<param format="real" max="3.0" min="0.0" nom="concrr">0.02000</param>
<param format="real" max="30.0" min="5.0" nom="plNmin">10.00000</param>
<param format="real" max="50.0" min="0.0" nom="irrlev">20.00000</param>
<param format="real" max="50.0" min="0.0" nom="QNpltminINN">0.00000</param>
<option choix="2" nom="Nitrogen fixation by legumes" nomParam="codesymbiose">
<choix code="1" nom="critical nitrogen"/>
<choix code="2" nom="nodule activity">
<option choix="2" nom="mineral nitrogen inhibition" nomParam="codefxn">
<choix code="1" nom="no effect"/>
<choix code="2" nom="nitrogen amount"/>
<choix code="3" nom="nitrogen concentration"/>
</option>
</choix>
</option>
</formalisme>
```

* Parameters with several values (for soil layers, technical operations,...)    
Several values may be defined for example relatively to soil parameters (different layers) or for crop management operations (with time repetitions). 

* Example from soil files    
In the above file extract for soil parameters, each set of parameters is repeated for each soil layer (up to 5). The parameters names are defined in a `nom` attribute for each `colonne` XML tag.    

```xml

<sol nom="solcanne">

...

<tableau nb_colonnes="8" nom="layer 1">
<colonne nom="epc">20.00</colonne>
<colonne nom="HCCF">46.80</colonne>
<colonne nom="HMINF">26.20</colonne>
<colonne nom="DAF">1.08</colonne>
<colonne nom="cailloux">0.00</colonne>
<colonne nom="typecailloux">1</colonne>
<colonne nom="infil">50.00</colonne>
<colonne nom="epd">10</colonne>
</tableau>

...

<tableau nb_colonnes="8" nom="layer 5">
<colonne nom="epc">20.00</colonne>
<colonne nom="HCCF">50.10</colonne>
<colonne nom="HMINF">25.50</colonne>
<colonne nom="DAF">0.99</colonne>
<colonne nom="cailloux">0.00</colonne>
<colonne nom="typecailloux">1</colonne>
<colonne nom="infil">50.00</colonne>
<colonne nom="epd">10</colonne>
</tableau>
</sol>

...

```

* Example from tec files    
In the above file extract for crop management parameters, each set of parameters is repeated for each operation (undefined number). The parameters names are defined in a `nom` attribute for each `colonne` XML tag, inside an `intervention` node.

```xml
<formalisme nom="supply of organic residus">
<ta nb_interventions="5" nom="interventions">
<ta_entete nb_colonnes="7">
<colonne nom="julres"/>
<colonne nom="coderes"/>
<colonne nom="qres"/>
<colonne nom="Crespc"/>
<colonne nom="CsurNres"/>
<colonne nom="Nminres"/>
<colonne nom="eaures"/>
</ta_entete>
<intervention nb_colonnes="7">
<colonne nom="julres">112</colonne>
<colonne nom="coderes">1</colonne>
<colonne nom="qres">1.00</colonne>
<colonne nom="Crespc">42.00</colonne>
<colonne nom="CsurNres">60.00</colonne>
<colonne nom="Nminres">0.00</colonne>
<colonne nom="eaures">0.00</colonne>
</intervention>

...

<intervention nb_colonnes="7">
<colonne nom="julres">220</colonne>
<colonne nom="coderes">2</colonne>
<colonne nom="qres">1.00</colonne>
<colonne nom="Crespc">42.00</colonne>
<colonne nom="CsurNres">60.00</colonne>
<colonne nom="Nminres">0.00</colonne>
<colonne nom="eaures">0.00</colonne>
</intervention>
</ta>
</formalisme>
```

> Rules have been defined to search and extract information inside XML files in order to simplify the way of using functions dedicated to XML files manipulations.    
>
>In some cases, information relative to upward dependence are needed for extracting parameters values, but in most cases only the parameters names are mandatory in functions arguments.


# Getting XML files examples from the library

> We have included several XML examples files in the package in order to make `reproducible`
> **manipulations** and **results** described in this document. They are extracted from the JavaStics 
> standard distribution (some of them have just been renamed).

## Set the XML files examples source directory 
In xml_dir, we store the directory path of the XML files included in the library installation.

```{r set_xml_dir}
xml_dir <- system.file(file.path("extdata","xml","examples","V9.1"), package = "SticsRFiles" )

# For linux 
#> "/path/to/user/R/x86_64-pc-linux-gnu-library/3.6/SticsRFiles/extdata/xml/examples/V9.1"

# For windows
#> "C:/Users/username/Documents/R/win-lib/3.6/SticsRFiles/extdata/xml/examples/V9.1"

```

## List examples files

```{r}

xml_files <- list.files(path = xml_dir, pattern = ".xml$", full.names = T)

# Listing only the first three files of the entire list 

# head(xml_files, n = 3)
# For linux 
#> [1] "/path/to/user/R/x86_64-pc-linux-gnu-library/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_ini.xml"     
#> [2] "/path/to/user/R/x86_64-pc-linux-gnu-library/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_plt.xml"     
#> [3] "/path/to/user/R/x86_64-pc-linux-gnu-library/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_sta.xml"     

# For windows
#> [1] "C:/Users/username/Documents/R/win-lib/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_ini.xml"   
#> [2] "C:/Users/username/Documents/R/win-lib/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_plt.xml"    
#> [3] "C:/Users/username/Documents/R/win-lib/3.6/SticsRFiles/extdata/xml/examples/V9.1/file_sta.xml"     

```



## Copying files in a local directory

### A specific file


```{r}
# Setting a local directory path
# xml_loc_dir <- "/path/to/local/directory"

file.copy(from = file.path(xml_dir,"sols.xml"), to = xml_loc_dir)
```

### All files
```{r}
file.copy(from = xml_files,to = xml_loc_dir)
```


<!--
# REMOVED SECTION, only describing find_param_names
# Retrieving parameters names from files


## From a file

```{r}
sols <- file.path(xml_loc_dir,"sols.xml")

get_param_names_xml(sols)
```


## From a files list
### Getting a list of data.frames
```{r}
par_gen <- file.path(xml_loc_dir,"param_gen.xml")

files_list <- c(sols, par_gen)

param_names <- get_param_names_xml(xml_file = files_list, combine = FALSE)

head(param_names[[1]], n = 10)

head(param_names[[2]], n = 10)


```
### Getting a unique of data.frame (with file names)
```{r}

param_names <- get_param_names_xml(xml_file = files_list)

head(param_names, n = 10)


``` 
-->

# Searching parameters names from files

The `find_param_names` only take the names or names substring of a parameter or a parameters list and by default searches in an XML files list according to a model version (9.1 as the default one).

In that case, we do not care of which XML file(s) may contain the searched parameter(s). 

Some warnings may be displayed, in case of duplicate values for bounds. In that case the retained values are indicated in the warning message.


## Finding one or more parameters names

```{r, results="markup"}

param_names <- find_param_names(name = "albedo")


param_names


param_names <- find_param_names(name = c("albedo", "latitude", "humcapil"))

param_names

```

## Finding parameters names using partial names

```{r}

param_names <- find_param_names(name = "hum")

param_names


param_names <- find_param_names(name = c("al","hum"))

# Displaying only some head lines of the data.frame
head(param_names, n = 10)

```

> More specific extractions for parameter names can be performed using the `get_param_names_xml`. In that case, XML file or files list in which to search must be specified as a function input argument.





# Searching parameters formalisms from files

The `find_param_formalisms` as `find_param_names`, only take the names or names substring of a parameter or a parameters list and by default searches in an XML files list according to a model version (9.1 as the default one).

In that case, we do not care of which XML file(s) may contain the searched parameter(s). 

## Finding one or more parameters formalisms

```{r, warning=FALSE}

param_formalisms <- find_param_formalisms(name = "albedo")


param_formalisms


param_formalisms <- find_param_formalisms(name = c("albedo", "latitude", "humcapil"))

param_formalisms

```

## Finding formalisms using partial parameters names

```{r, warning=FALSE}

param_formalisms <- find_param_formalisms(name = "hum")

param_formalisms


param_formalisms <- find_param_formalisms(name = c("al","hum"))

head(param_formalisms)

```

> More specific extractions for parameter names can be performed using the `get_formalisms_xml`. In that case, XML file or files list in which to search must be specified as a function input argument.



# Getting parameters values from a file


## Scalar parameters
* For one parameter and one occurence    
```{r}


# A option parameter
get_param_xml(par_gen, param_names = "codeactimulch" )

# A simple parameter
get_param_xml(par_gen, param_names = "tnitopt" )

# Using a conditional selection
get_param_xml(sols,param_names = "argi", parent_name = "sol",
              parent_sel_attr = "solcanne")

```

* For one parameter and several occurences    
```{r}

# For all soils
get_param_xml(sols,param_names = "argi" )
```    
  
* For several parameters and several occurrences    
```{r}

# For all soils
get_param_xml(sols,param_names = c("argi", "pH") )
```    
* For several parameters and one occurrence (conditional selection)    

```{r}

# For one soil
get_param_xml(sols,param_names = c("argi", "pH") , parent_name = "sol",
              parent_sel_attr = "solcanne")
```


## Vector parameters
* All values (for all soil layers, or crop management operations)
```{r}
# For all soil layers
get_param_xml(sols, param_names = c("epc", "infil"), parent_name = "sol",
              parent_sel_attr = "solcanne" )
```

```{r}
# For all irrigation operations
tec <- file.path(xml_loc_dir,"file_tec.xml")
get_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"))

```

* Selecting with values index   

```{r}
# For soil layers 1 to 3
get_param_xml(sols,param_names = c("epc", "infil"), parent_name = "sol",
              parent_sel_attr = "solcanne", ids = 1:3 )
```

```{r}

# For irrigation operations 1 to 5
get_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"), ids = 1:5)

```


## Getting all parameters values

```{r}
tec_param_names <- get_param_names_xml(tec)[[1]]

tec_param_values <- get_param_xml(tec, param_names = tec_param_names)[[1]]

# Displaying only a subset of the list
head(tec_param_values, n = 10)

```


# Replacing parameters values in files

## Defining the output file from functions arguments
The function **set_param_xml** allows to set the output file with the following optional arguments as follows:
* For overwriting the existing file: use ```overwrite = TRUE```

* For generating a file in another directory: use `out_path` for setting an output directory

* Specifying a new file name: use  `out_file` for giving the new file name (inculding the .xml extension)



## Scalar parameters
* For one parameter and one occurence    
```{r}


# A option parameter
set_param_xml(par_gen,param_names = "codeactimulch", param_values = 2, overwrite = T )

# Controlling written values
get_param_xml(par_gen, param_names = "codeactimulch" )

# A simple parameter
set_param_xml(par_gen, param_names = "tnitopt", param_values = 29.5, overwrite = T )

# Controlling written values:
get_param_xml(par_gen, param_names = "tnitopt" )

# Using a conditional selection
set_param_xml(sols, param_names = "argi", param_values = 33, parent_name = "sol",
              parent_sel_attr = "solcanne", overwrite = T )

# Controlling written values
get_param_xml(sols,param_names = "argi", parent_name = "sol",
              parent_sel_attr = "solcanne")

```


* For one parameter and several occurences    
```{r}

# For all soils
# One value per occurence
set_param_xml(sols, param_names = "argi", param_values = list(1:33), overwrite = T )
# Controlling written values
get_param_xml(sols,param_names = "argi" )

# Same value for all occurences
set_param_xml(sols, param_names = "argi", param_values = 40, overwrite = T )

# Controlling written values
get_param_xml(sols,param_names = "argi" )


```    

* For several parameters and several occurrences    
```{r}

# For all soils
# One value per occurence
set_param_xml(sols, param_names = list("argi", "pH"), param_values = list(1:33,33:1), overwrite = T )
# Controlling written values
get_param_xml(sols,param_names = c("argi", "pH") )

# Same value for all occurences
set_param_xml(sols, param_names = c("argi", "pH"), param_values = list(50, 8), overwrite = T )
# Controlling written values
get_param_xml(sols,param_names = c("argi", "pH") )


```    
* For several parameters and one occurrence (conditional selection)    

```{r}

# For one soil
set_param_xml(sols, param_names = c("argi", "pH"), param_values = list(50,8), parent_name = "sol",
              parent_sel_attr = "solcanne", overwrite = T )
# Controlling written values
get_param_xml(sols,param_names = c("argi", "pH") , parent_name = "sol",
              parent_sel_attr = "solcanne")
```


## Vector parameters
* All values (for all soil layers, or crop management operations)
```{r}
# For all soil layers
set_param_xml(sols, param_names = c("epc", "infil"), param_values = list(18:22,48:52), parent_name = "sol", parent_sel_attr = "solcanne", overwrite = T )
# Controlling written values
get_param_xml(sols, param_names = c("epc", "infil"), parent_name = "sol",
              parent_sel_attr = "solcanne" )
```

```{r}
# For all irrigation operations
tec <- file.path(xml_loc_dir,"file_tec.xml")
set_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"), param_values = list(200:215,20:35), overwrite = T )
# Controlling written values
get_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"))

```

* Some values   

```{r}
# For soil layers 1 to 3
set_param_xml(sols, param_names = c("epc", "infil"), param_values = list(20:18,50:48), parent_name = "sol", parent_sel_attr = "solcanne", overwrite = T, ids = 1:3 )
# Controlling written values
get_param_xml(sols,param_names = c("epc", "infil"), parent_name = "sol",
              parent_sel_attr = "solcanne", ids = 1:3 )
```

```{r}

# For irrigation operations 1 to 5 (same indices for all parameters)
set_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"), param_values = list(204:200,24:20), overwrite = T, ids = 1:5)
# Controlling written values
get_param_xml(tec, param_names = c("julapI_or_sum_upvt", "amount"), ids = 1:5)

```

# Using functions with a files list
It's so possible to extract parameters names list for a list of files.

This is also handled already for easily getting parameters values from files of the same kind.

But, setting parameters values into several files is not possible at the moment.









